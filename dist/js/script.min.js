const token="a77df976-cc73-4f1b-8224-7f0bab238df9",signIn=()=>{document.querySelector(".main");const a=document.querySelector(".header-block__btn"),i=document.querySelector(".modal");var e=document.querySelector(".close");const s=document.querySelector(".header-block__btn-create");a.addEventListener("click",()=>i.classList.toggle("modal--visible")),e.addEventListener("click",()=>i.classList.remove("modal--visible")),document.getElementById("login-button").onclick=async function(){const t=document.getElementById("username").value,r=document.getElementById("password").value;event.preventDefault(),await fetch("https://ajax.test-danit.com/api/v2/cards/login",{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify({email:t,password:r})}).then(e=>{e.ok?(i.style.display="none",a.style.display="none",s.style.display="flex",localStorage.setItem("username",t),localStorage.setItem("password",r)):console.log("Login failed")}).catch(e=>{console.error(e)})};var e=localStorage.getItem("username"),t=localStorage.getItem("password");e&&t&&(document.getElementById("username").value=e,document.getElementById("password").value=t,document.getElementById("login-button").click())};signIn();class VisitModal{constructor(){this.modal=null}openModal(){var e=this.renderVisit(),t=document.createElement("div");t.innerHTML=e,this.modal=t.firstChild,document.body.appendChild(this.modal)}renderVisit(){return`<form class="main-modal__create-visit">
      <label for="doctor-select">Оберіть лікаря:</label>
      <select id="doctor-select" name="doctor">
        <option value="Кардіолог">Кардіолог</option>
        <option value="Терапевт">Терапевт</option>
        <option value="Стоматолог">Стоматолог</option>
      </select>
      <div id="doctor-fields">
        <label for="purpose">Ціль візиту:</label>
        <input type="text" id="purpose" name="purpose" required><br>

        <label for="description">Короткий опис візиту:</label>
        <textarea id="description" name="description"></textarea><br>

        <label for="urgency">Терміновість:</label>
        <select id="urgency" name="urgency">
          <option value="Звичайна">Звичайна</option>
          <option value="Пріоритетна">Пріоритетная</option>
          <option value="Невідкладна">Невідкладна</option>
        </select><br>
        <label for="fullname">ПІБ:</label>
        <input type="text" id="fullname" name="fullname" required><br>
      </div>
      <div id="doctors-container">
          <label for="pressure">Звичайний тиск:</label>
          <input type="text" id="pressure" name="pressure" required><br>

          <label for="bmi">Індекс маси тіла:</label>
          <input type="text" id="bmi" name="bmi" required><br>

          <label for="heartDiseases">Перенесені захворювання серцево-судинної системи:</label>
          <input type="text" id="heartDiseases" name="heartDiseases" required><br>
          <label for="age">Вік:</label>
          <input type="text" id="age" name="age" required><br>
        </div>
      <button type="submit" class="submit">Записатися на прийом</button>
      <button class="cancel">Закрити</button>
    </form>`}therapistRender(){return`<div id="doctors-container" >
          <label for="age">Вік:</label>
          <input type="text" id="age" name="age"><br>
        </div>`}dentistRender(){return`<div id="doctors-container">
          <label for="lastVisit">Дата останього візиту:</label>
          <input type="text" id="lastVisit" name="lastVisit" required><br>
        </div>`}cardiologistRender(){return`<div id="doctors-container">
          <label for="pressure">Звичайний тиск:</label>
          <input type="text" id="pressure" name="pressure" required><br>

          <label for="bmi">Індекс маси тіла:</label>
          <input type="text" id="bmi" name="bmi" required><br>

          <label for="heartDiseases">Перенесені захворювання серцево-судинної системи:</label>
          <input type="text" id="heartDiseases" name="heartDiseases" required><br>
          <label for="age">Вік:</label>
          <input type="text" id="age" name="age" required><br>
        </div>`}initModal(){var e=document.createElement("div");e.classList.add("main-modal"),e.innerHTML=this.renderVisit(),document.body.appendChild(e),e.querySelector(".cancel").addEventListener("click",this.closeModal.bind(this)),this.listenForClickOutside()}listenForClickOutside(){this.boundClickOutsideHandler=e=>{document.querySelector(".main-modal").querySelector(".main-modal__create-visit").contains(e.target)||this.closeModal()},setTimeout(()=>{document.addEventListener("click",this.boundClickOutsideHandler)},0)}removeClickOutsideListener(){document.removeEventListener("click",this.boundClickOutsideHandler)}closeModal(){var e=document.querySelector(".main-modal");this.removeClickOutsideListener(),e.parentNode.removeChild(e)}whoesDoctor(){const t=document.querySelector("#doctor-fields");document.querySelector("#doctor-select").addEventListener("change",e=>{e.target.value,"Кардіолог"===e.target.value?(this.deleteDoctors(),t.insertAdjacentHTML("afterend",this.cardiologistRender())):"Стоматолог"===e.target.value?(this.deleteDoctors(),t.insertAdjacentHTML("afterend",this.dentistRender())):"Терапевт"===e.target.value&&(this.deleteDoctors(),t.insertAdjacentHTML("afterend",this.therapistRender()))})}deleteDoctors(){document.querySelector("#doctors-container").remove()}async pushData(){const t=document.querySelector(".main-modal__create-visit");document.querySelector(".submit").addEventListener("click",async e=>{e.preventDefault(),t.checkValidity()?(e=new FormData(t),e=Object.fromEntries(e.entries()),await requestCreate(e),this.closeModal()):alert("Будь-ласка, заповніть усі поля.")})}}const requestCreate=async e=>{try{var t=await fetch("https://ajax.test-danit.com/api/v2/cards",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+token},body:JSON.stringify(e)});if(!t.ok)throw new Error("HTTP error! status: "+t.status);await t.json(),getCards()}catch(e){return console.error("Error fetching data:",e),!1}};class Cards{constructor(e,t,r,a,i,s,o,l,n,d){this.id=e,this.fullname=t,this.doctor=r,this.purpose=a,this.description=i,this.urgency=s,this.pressure=o,this.bmi=l,this.age=n,this.lastVisit=d}renderForm(){return`
    <form class="users-card__block" id="${this.id}" data-tab=${this.id} draggable="true" ondragstart="dragStart(event, this)">
      <p class="users-card__title">Дані про Ваш запис (Ваш персональний номер): №${this.id}</p>
      <ul class="users-card__info-list">
        <li class="users-card__info-item" id="fullname">ПІБ: ${this.fullname}</li>
        <li class="users-card__info-item" id="doctor">До лікаря: ${this.doctor}</li>
      </ul>
      <ul class="users-card__full-info-list--hidden" data-tab=${this.id}>
        <li class="users-card__full-info-item" id="purpose">Ціль візиту: ${this.purpose}</li>
        <li class="users-card__full-info-item" id="description">Короткий опис візиту: ${this.description}</li>
        <li class="users-card__full-info-item" id="urgency">Терміновість: ${this.urgency}</li>
        <li class="users-card__full-info-item" id="pressure">Звичайний тиск: ${this.pressure}</li>
        <li class="users-card__full-info-item" id="bmi">Індекс маси тіла: ${this.bmi}</li>
        <li class="users-card__full-info-item" id="heartDiseases">Перенесені захворювання серцево-судинної системи: ${this.heartDiseases}</li>
        <li class="users-card__full-info-item" id="age">Вік: ${this.age}</li>
        <li class="users-card__full-info-item" id="lastVisit">Дата останього візиту: ${this.lastVisit}</li>
      </ul>
      <div class="users-card__delete-icon" onclick="deleteCard(${this.id})"></div>
      <button type="button" class="users-card__button-show-more" onclick="showMore(${this.id}, event)">Показати більше</button>
      <button class="users-card__button-edit" style="display: none;" onclick="editCard(${this.id},event)">Редагувати</button>
    </form>
  `}renderEditForm(){return`
      <form class="users-card__edit-form" data-tab="${this.id}" onsubmit="event.preventDefault(); saveEditedCard(${this.id}, this);">
        <label>ПІБ: <input type="text" name="fullname" value="${this.fullname}"></label>
        <label>Лікар:
        <select name="doctor">
        <option value="Терапевт" ${"Терапевт"===this.doctor?"selected":""}>Терапевт</option>
        <option value="Кардіолог" ${"Кардіолог"===this.doctor?"selected":""}>Кардіолог</option>
        <option value="Стоматолог" ${"Стоматолог"===this.doctor?"selected":""}>Стоматолог</option>
        </select>
        </label>
        <label>Ціль візиту: <input type="text" name="purpose" value="${this.purpose}"></label>
        <label>Опис візиту: <input type="text" name="description" value="${this.description}"></label>
        <label>Терміновість:
        <select name="urgency">
        <option value="Звичайна" ${"Звичайна"===this.urgency?"selected":""}>Звичайна</option>
        <option value="Пріоритетна" ${"Пріоритетна"===this.urgency?"selected":""}>Пріоритетна</option>
        <option value="Невідкладна" ${"Невідкладна"===this.urgency?"selected":""}>Невідкладна</option>
        </select>
        </label>
        <label>Звичайний тиск: <input type="text" name="pressure" value="${this.pressure}"></label>
        <label>Індекс маси тіла: <input type="text" name="bmi" value="${this.bmi}"></label>
        <label>Вік: <input type="text" name="age" value="${this.age}"></label>
        <label>Дата останього візиту: <input type="text" name="lastVisit" value="${this.lastVisit}"></label>
        <button type="submit">Зберігти</button>
        <button type="button" onclick="cancelEditing(${this.id}, event)">Відміна</button>
      </form>
    `}}const removeUndefinedEditFields=e=>{e=document.querySelector(`form[data-tab="${e}"].users-card__edit-form`);Array.from(e.querySelectorAll("input")).forEach(e=>{"undefined"===e.value&&e.parentElement.remove()})},getCards=async()=>{var e=await(await fetch("https://ajax.test-danit.com/api/v2/cards",{method:"GET",headers:{Authorization:"Bearer: "+token}})).json();document.querySelector(".main__users-card").innerHTML=e.map(e=>{e=new Cards(e.id,e.fullname,e.doctor,e.purpose,e.description,e.urgency,e.pressure,e.bmi,e.age,e.lastVisit);return e.renderForm()+e.renderEditForm()}).join(""),removeUndefinedFields()},deleteCard=async e=>{(await fetch("https://ajax.test-danit.com/api/v2/cards/"+e,{method:"DELETE",headers:{Authorization:"Bearer: "+token}})).ok&&(document.querySelector(`form[data-tab="${e}"]`).remove(),updateEmptyMessage())},showMore=(e,t)=>{t.preventDefault();var r=document.querySelector(`ul[data-tab="${e}"].users-card__full-info-list--hidden`),t=t.target,e=document.querySelector(`form[data-tab="${e}"] .users-card__button-edit`);r.classList.remove("users-card__full-info-list--hidden"),r.classList.add("users-card__full-info-list"),t.remove(),e.style.display="inline-block"},removeUndefinedFields=()=>{document.querySelectorAll(".users-card__full-info-list--hidden").forEach(e=>{Array.from(e.children).forEach(e=>{e.textContent.includes("undefined")&&0<e.textContent.trim().length&&e.remove()})})},editCard=(e,t)=>{t.preventDefault();var t=document.querySelector(`ul[data-tab="${e}"]`),r=document.querySelector(`form[data-tab="${e}"].users-card__edit-form`),a=document.querySelector(`form[data-tab="${e}"] .users-card__delete-icon`);t.style.display="none",r.style.display="block",a.classList.add("disable-events"),removeUndefinedEditFields(e)},saveEditedCard=async(e,t)=>{t=new FormData(t);const r={};t.forEach((e,t)=>{"undefined"!==e&&(r[t]=e)});t=await fetch("https://ajax.test-danit.com/api/v2/cards/"+e,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer: "+token},body:JSON.stringify(r)});t.ok?getCards():console.error("Error updating card:",t.status)},cancelEditing=(e,t)=>{t.preventDefault();var t=document.querySelector(`ul[data-tab="${e}"]`),r=document.querySelector(`form[data-tab="${e}"].users-card__edit-form`),e=document.querySelector(`form[data-tab="${e}"] .users-card__delete-icon`);t.style.display="block",r.style.display="none",e.classList.remove("disable-events")};async function modalToHTML(){document.querySelector(".header-block__btn-create").addEventListener("click",async()=>{var e=new VisitModal;e.initModal(),e.whoesDoctor(),await e.pushData()})}getCards().then(()=>{updateEmptyMessage()}),modalToHTML();const filterCards=()=>{const s=document.querySelector("#search"),o=document.querySelector("#status"),l=document.querySelector("#priority");document.querySelectorAll(".users-card__block").forEach(e=>{var t=e.querySelector("#fullname").textContent,r=e.querySelector("#description").textContent,a=e.querySelector("#urgency").textContent,i=e.querySelector("#doctor").textContent,t=t.toLowerCase().includes(s.value.toLowerCase())||r.toLowerCase().includes(s.value.toLowerCase()),r=""===o.value||a.includes(o.value),a=""===l.value||i.includes(l.value);e.style.display=t&&r&&a?"block":"none"})},updateEmptyMessage=(document.querySelector("#search").addEventListener("input",filterCards),document.querySelector("#status").addEventListener("change",filterCards),document.querySelector("#priority").addEventListener("change",filterCards),()=>{var e=document.querySelectorAll(".users-card__block"),t=document.querySelector("#empty-message");0===e.length?t||((e=document.createElement("p")).id="empty-message",e.textContent="No items have been added",document.querySelector(".main__users-card").appendChild(e)):t&&t.remove()}),dragStart=e=>{e.dataTransfer.setData("text/plain",e.target.id),e.target.classList.add("dragged"),setTimeout(()=>{e.target.style.opacity="0.0"},0)},dragOver=e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},drop=(e,t)=>{e.preventDefault();var r=e.dataTransfer.getData("text/plain"),r=document.getElementById(r),a=Array.from(t.querySelectorAll("form.users-card__block"));let i;r.style.display="none";var s=document.elementFromPoint(e.clientX,e.clientY);r.style.display="";for(let e=0;e<a.length;e++){var o=a[e];if(o.contains(s)){i=o;break}}i?i!==r&&i.nextElementSibling!==r&&t.insertBefore(r,i):t.appendChild(r),r.style.opacity="1",r.classList.remove("dragged")};